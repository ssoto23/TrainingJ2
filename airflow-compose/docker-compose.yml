version: '3.7'
services:
  postgres:
    image: postgres:9.6
    environment:
        - POSTGRES_USER=airflow
        - POSTGRES_PASSWORD=airflow
        - POSTGRES_DB=airflow
    logging:
        options:
            max-size: 10m
            max-file: "3"
    
  webserver:
    image: puckel/docker-airflow:1.10.7
    restart: always
    depends_on:
        - postgres
    environment:
        - LOAD_EX=n
        - EXECUTOR=Sequential
    logging:
        options:
            max-size: 10m
            max-file: "3"
    volumes:
        - ./dags:/usr/local/airflow/dags
        # - ./plugins:/usr/local/airflow/plugins
    ports:
        - "18080:8080"
    command: webserver
    healthcheck:
        test: ["CMD-SHELL", "[ -f /usr/local/airflow/airflow-webserver.pid ]"]
        interval: 30s
        timeout: 30s
        retries: 3
        
  spark-master:
    image: bde2020/spark-master:2.4.3-hadoop2.7
    container_name: spark-master
    hostname: spark-master
    ports:
      - "18081:8080"
      - "7077:7077"
      - 14040:4040
      - 33139-33155:33139-33155
      - 45029-45045:45029-45045
    environment:
      - INIT_DAEMON_STEP=setup_spark     
      
  spark-worker-1:
    image: bde2020/spark-worker:2.4.3-hadoop2.7
    container_name: spark-worker-1
    hostname: spark-worker-1
    depends_on:
      - spark-master
    ports:
      - "18082:8081"
    environment:
      - "SPARK_MASTER=spark://spark-master:7077"
      
  spark-worker-2:
    image: bde2020/spark-worker:2.4.3-hadoop2.7
    container_name: spark-worker-2
    hostname: spark-worker-2
    depends_on:
      - spark-master
    ports:
      - "18083:8081"
    environment:
      - "SPARK_MASTER=spark://spark-master:7077" 

  spark-worker-3:
    image: bde2020/spark-worker:2.4.3-hadoop2.7
    container_name: spark-worker-3
    hostname: spark-worker-3
    depends_on:
      - spark-master
    ports:
      - "18084:8081"
    environment:
      - "SPARK_MASTER=spark://spark-master:7077" 

  zeppelin:
    container_name: zeppelin
    hostname: zeppelin
    build:
      context: zeppelin/
    restart: unless-stopped
    environment:
      ZEPPELIN_PORT: 8090
      ZEPPELIN_JAVA_OPTS: >-
        -Dspark.driver.memory=1g
        -Dspark.executor.memory=2g
      MASTER: "spark://spark-master:7077"    
    volumes:
      - ./logs:/zeppelin/logs
      - ./notebooks:/zeppelin/notebook
      - ./sample-data:/sample-data:ro
    ports:
      - "18090:8090"
    labels:
      container_group: "notebook"